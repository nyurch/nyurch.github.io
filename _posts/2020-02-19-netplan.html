---
layout: post
title: Завантаження та установка ОС з PXE-сервера. Чорновик.
category: [LINUX]
---
<a rel="colorbox" href="/media/PXE_diagram.png" >
     <img class="head" src="/media/PXE_diagram.png"  alt="">
</a>
<p>Частково по необхідності, частково для саморозвитку.<!--more--></p>
<h4>Windows</h4>
<p>Для максимально швидкого розвертання <term>PXE-сервера</term> у <term>Windows</term> використовую на даний момент <term>Serva</term>. Обмеження безкоштовної версії:</p>
<ol>
<li>Сервер піднятий "тільки" 50хв., після чого треба перезапустити;</li>
<li>7с очікування при запуску;</li>
<li>Конфіг одночасно може бути налаштований на запуск/установку тільки 2 різних систем;</li>
</ol>
<p>Останній пункт робить безкоштовну версію непридатною до розвертання як постійного тестувально/установочного сервера, але якщо треба дуже швидко і <term>Windows</term> то краще поки не бачив.<br>Скріншоти налаштувань, використовуються лише закладки <b>TFTP</b> та <b>DHCP</b></p>
<a rel="colorbox" href="/media/serva-0-tftp.png" >
     <img class="head" src="/media/serva-0-tftp.png"  alt="">
</a>
<a rel="colorbox" href="/media/serva-1-dhcp.png" >
     <img class="head" src="/media/serva-1-dhcp.png"  alt="">
</a>
<p>Після конфігурації програму закриваємо. Тепер у директорії <path>.\serva_stor</path> створюємо директорії <b>WIA_WDS</b> - для  <term>Windows</term> та <b>NWA_PXE</b> - для <term>Linux</term> і робимо їх доступними по мережі з іменами <b>WIA_WDS_SHARE</b> та <b>NWA_PXE_SHARE</b>. Розпаковуємо туди необхідні дистрибутиви і запускаємо сервер. Решту директорій і меню-завантаження сервер згенерує сам. При бажанні можна облагородити, меню знаходиться в директорії <path>.\serva_stor\BM\PXESERVA</path>, окремо для <b>BIOS</b> та <b>EFI</b>. Фінальне дерево каталогів буде якесь таке:</p>
<a rel="colorbox" href="/media/serva-dir.png" >
     <img class="head" src="/media/serva-dir.png"  alt="">
</a>

<h4>Linux</h4>
<p>А тепер на стільки на скільки це можна комфортно, практично реалізовувалося на <term>Linux Mint XFCE</term>:</p>
<ol>
<li>Сервер повинен мати статичну ip-адресу, так пишуть, з динамічною не перевіряв;</li>
<li>Встановлюємо <b>dnsmasq</b>, <b>nfs-kernel-server</b>
<xmp class="bsh">apt install -y dnsmasq nfs-kernel-server</xmp></li>
<li>Файл конфігурації <path>/etc/dnsmasq.conf</path>
<xmp class="lst"># Don't function as a DNS server:
port=0

# Log lots of extra information about DHCP transactions.
log-dhcp

# Set the root directory for files available via FTP.
tftp-root=/netboot/tftp
enable-tftp

# The boot filename, Server name, Server Ip Address
dhcp-boot=x86PC,pxelinux.0,192.168.7.13

# Disable re-use of the DHCP servername and filename fields as extra
# option space. That's to avoid confusing some old or broken DHCP clients.
dhcp-no-override

# inspect the vendor class string and match the text to set the tag
dhcp-vendorclass=BIOS,PXEClient:Arch:00000
dhcp-vendorclass=UEFI32,PXEClient:Arch:00006
dhcp-vendorclass=UEFI,PXEClient:Arch:00007
dhcp-vendorclass=UEFI64,PXEClient:Arch:00009

# Set the boot file name based on the matching tag from the vendor class (above)
#dhcp-boot=net:UEFI32,i386-efi/ipxe.efi,,192.168.7.13
#dhcp-boot=net:UEFI,bootx64.efi,,192.168.7.13
dhcp-boot=net:UEFI64,bootx64.efi,,192.168.7.13

# PXE menu.  The first part is the text displayed to the user.  The second is the timeout, in seconds.
pxe-prompt="Press F8 for PXE Network boot...", 10

# The known types are x86PC, PC98, IA64_EFI, Alpha, Arc_x86,
# Intel_Lean_Client, IA32_EFI, BC_EFI, Xscale_EFI and X86-64_EFI
# This option is first and will be the default if there is no input from the user.
pxe-service=x86PC, "Install OS via PXE", pxelinux
pxe-service=X86-64_EFI, "Grrrrrr", bootx64.efi
#pxe-service=BC_EFI, "Boot to FOG UEFI PXE-BC", bootx64.efi

dhcp-range=192.168.7.13,proxy</xmp>
Це з претензією на автовизначення bios/ufi, але на даний момент з EFI по суті не працює(тільки syslinux, але він в EFI катастрофічно тормозний, при тому що він і в BIOS, і напряму з флешки тормозніший за grub.) Тому реально конфіг можна укоротити до такого:
<xmp class="lst"># Don't function as a DNS server:
port=0

# Log lots of extra information about DHCP transactions.
log-dhcp

# Set the root directory for files available via FTP.
tftp-root=/netboot/tftp
enable-tftp

# The boot filename, Server name, Server Ip Address
dhcp-boot=x86PC,pxelinux.0,192.168.7.13

# Disable re-use of the DHCP servername and filename fields as extra
# option space. That's to avoid confusing some old or broken DHCP clients.
dhcp-no-override

# PXE menu.  The first part is the text displayed to the user.  The second is the timeout, in seconds.
pxe-prompt="Press F8 for PXE Network boot...", 10
pxe-service=x86PC, "Install OS via PXE", pxelinux

# Respond to PXE requests for the specified network;
# run as DHCP proxy
dhcp-range=192.168.7.13,proxy</xmp>
</li>
<li>Якщо треба щоб <b>dnsmasq</b> ще й як dhcp-сервер працював треба додати
<xmp class="lst">dhcp-range=eth0,192.168.7.100,192.168.7.240,255.255.255.0,8h # карта, діапазон адрес що видаються, маска, час на який видаються
dhcp-option=option:dns-server,192.168.7.13
dhcp-option=option:dns-server,8.8.8.8</xmp></li>
<li>Перезапускаємо <b>dnsmasq</b></b>
<xmp class="bsh">sudo systemctl restart dnsmasq</xmp></li>
<li>Створюємо основну директорію
<xmp class="bsh">sudo mkdir -p /netboot/tftp</xmp></li>
<li>Створюємо директорію nfs-сервера
<xmp class="bsh">sudo mkdir -p /netboot/nfs</xmp></li>
<li>Додаємо рядок в кінець файла <path>/etc/exports</path>
<xmp class="lst">/netboot/nfs  *(ro,sync,no_wdelay,insecure_locks,no_root_squash,insecure,no_subtree_check)</xmp></li>
<li>І робимо спільний ресурс доступним
<xmp class="bsh">sudo exportfs -a</xmp></li>
<li>Копіюємо чи створюємо посилання на файл <path>/usr/lib/syslinux/memdisk</path> необхідного для завантаження напряму з iso-образу
<xmp class="bsh">sudo ln -s /usr/lib/syslinux/memdisk /netboot/tftp</xmp></li>
<li>Створюємо директорії з яких будуть ставитися linux-системи, Linux Mint 19 XFCE, у нашому випадку
<xmp class="bsh">sudo mkdir /netboot/nfs/mint19
sudo mkdir /netboot/tftp/net/mint19</xmp></li>
<li>Монтуємо образ лінукса і копіюємо всі файли до /netboot/nfs/mint19
<xmp class="bsh">sudo mount -o loop isoname.iso /mnt
sudo cp -Rfv /mnt/* /netboot/nfs/mint19/</xmp></li>
<li>А до /netboot/tftp/net/mint19 копіюємо тільки те що необхідно щоб почати завантаження по мережі
<xmp class="bsh">sudo cp -v /netboot/nfs/mint19/casper/{vmlinuz,initrd.lz} /netboot/tftp/net/mint19/</xmp></li>
<li>Ставимо syslinux
<xmp class="bsh">sudo apt install -y syslinux pxelinux</xmp></li>
<li>Копіюємо необхідні файли syslinux в основну директорію
<xmp class="bsh">sudo cp -v /usr/lib/syslinux/modules/bios/{ldlinux.c32,libcom32.c32,libutil.c32,vesamenu.c32} /netboot/tftp
sudo cp -v /usr/lib/PXELINUX/pxelinux.0 /netboot/tftp/</xmp></li>
<li>Створюємо конфігураційні файли завантажувача
<xmp class="bsh">sudo mkdir /netboot/tftp/pxelinux.cfg
sudo touch /netboot/tftp/pxelinux.cfg/default</xmp></li>
<li>Окультурений зразок основного конфігураційного файла
<xmp class="lst">default vesamenu.c32
TIMEOUT 150
MENU BACKGROUND pxelinux.cfg/back.png
MENU COLOR border 30;40 #00000000 #00c1c1c1 none

label install1
menu label ^Linux Mint 19 XFCE x64
menu default
kernel net/mint19/vmlinuz
append initrd=net/mint19/initrd.lz boot=casper netboot=nfs nfsroot=192.168.7.13:/netboot/nfs/mint19/ splash toram ---

label windows10
menu label ^WinPE10 PRO x64 Original
kernel /memdisk
initrd iso/winpe/winpe.iso
append iso raw

label windowsxpe10
menu label ^WinXPE10 x64
kernel /memdisk
initrd iso/winpe/Win10XPE_x64.ISO
append iso raw

label acronis
menu label ^TeraByte WinPE Acronis + TC
kernel /memdisk
initrd iso/acronis/Acronis10PE_26.11.2018.iso
append iso raw

label acronisPE
menu label ^All Acronis 2020
kernel /memdisk
initrd iso/acronis/acronis_mod31.iso
append iso raw

label Testing_tools
menu label ^Testing tools
kernel vesamenu.c32
append pxelinux.cfg/hard_test</xmp></li>
<li>Роздаємо права, здається зайве, треба протестити на чистій інсталяції
<xmp class="bsh">sudo chmod -Rfv 777 /netboot</xmp></li>
</ol>
