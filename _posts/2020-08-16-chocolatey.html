---
layout: post
title: Chocolatey. Створення власного пакету.
category: [ПРИКЛАДНІ ПРОГРАМИ]
---
<img class="head" src="/media/choco.png" alt="">
<p>Ком'юніті репозиторій Chocolatey містить фактично все що треба, але в той же час для деякого чисто корпоративного чи рідкісного софту треба писати самому. В нульовому наближенні це робиться якось так...<!--more--></p>
<ol>
	<li>Інсталимо якщо ще не встановлений <term>Chocolatey</term> та необхідні додаткові пакети.
    <xmp class = "bsh">powershell -NoProfile -ExecutionPolicy unrestricted -Command "iex ((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1'))" && SET PATH=%PATH%;%systemdrive%\chocolatey\bin</xmp>тут звертаємо увагу на <path>.\chocolatey\bin</path> бо положення може відрізнятися від версії до версії.
    <xmp class = "bsh">cinst warmup
cinst git
cinst nuget.commandline</xmp></li>
	<li>Йдемо в папку з chocolatey і створюємо папку packages де будуть зібрані пакети</li>
	<li>Генеруємо шаблон(на прикладі Total Commander)
<xmp class = "bsh">choco new totalcmd
cd totalcmd</xmp></li>
	<li>Правимо файли totalcmd.nuspec - описовий файл в корені та файл конфігурації chocolateyinstall.ps1</li>
	<li>Очищаємо файл конфігурації від всього закоментованого
<xmp class = "bsh">$f='C:\ProgramData\chocolatey\packages\totalcmd\tools\chocolateyinstall.ps1'
gc $f | ? {$_ -notmatch "^\s*#"} | % {$_ -replace '(^.*?)\s*?[^``]#.*','$1'} | Out-File $f+".~" -en utf8; mv -fo $f+".~" $f</xmp></li>
	<li>Генеруємо контрольну суму для установочного файлу.
<xmp class = "bsh">Get-FileHash tcmd951x32_64.exe | Format-List</xmp></li>
	<li>Генеруємо пакет для <term>Chocolatey</term>.
    <xmp class = "bsh">choco pack</xmp></li>
	<li>Перевірити наявність пакету можна так:
    <xmp class = "bsh">choco list -s C:\ProgramData\chocolatey\packages</xmp></li>
	<li>Тепер його можна встановлювати указавши джерело пакетів, без указання джерела його шукатиме на офіційному репозиторії.
    <xmp class = "bsh">choco install totalcmd -s C:\ProgramData\chocolatey\packages -y</xmp></li>
</ol>
<p>Зразки файлів конфігурації <path>totalcmd.nuspec</path></p>
<xmp class="lst"> <?xml version="1.0" encoding="utf-8"?>
<package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
  <metadata>
    <id>totalcmd</id>
    <version>9.51</version>
    <title>totalcmd (Install)</title>
    <authors>nyurch</authors>
    <projectUrl>https://www.ghisler.com/</projectUrl>
    <tags>totalcmd file manager</tags>
    <summary>file manager</summary>
    <description>file manager</description>
  </metadata>
  <files>
    <file src="tools\**" target="tools" />
  </files>
</package></xmp>
<p>та <path>chocolateyinstall.ps1</path></p>
<xmp class="lst">$ErrorActionPreference = 'Stop';
$toolsDir   = "$(Split-Path -parent $MyInvocation.MyCommand.Definition)"
$url        = 'C:\Users\zf\Downloads\tcmd951x32_64.exe'
файл chocolateyinstall.ps1
$packageArgs = @{
  packageName   = $env:ChocolateyPackageName
  unzipLocation = $toolsDir
  fileType      = 'EXE'
  url           = $url

  softwareName  = 'totalcmd*'

  checksum      = '2D2115049AEA04C0AF4090571F212AC553811338FA6C9EAEBFF88D6B61D35448'
  checksumType  = 'sha256'

  silentArgs    = "/AHMD`"$($env:TEMP)\$($packageName).$($env:chocolateyPackageVersion).MsiInstall.log`""
  validExitCodes= @(0, 3010, 1641)
}

Install-ChocolateyPackage @packageArgs</xmp>
